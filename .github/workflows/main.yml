# üß™ –ù–∞–∑–≤–∞–Ω–∏–µ workflow ‚Äî —Ç–∞–∫ –æ–Ω –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ Actions
name: Main Taski workflow

# üìÖ –£–∫–∞–∑—ã–≤–∞–µ–º, –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å workflow:
# –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches:
      - main

jobs:
  # –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∂–æ–±–∞ ‚Äî –∑–¥–µ—Å—å 'tests', –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º
  tests:
    # GitHub Actions –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–∂–æ–± –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ Ubuntu
    runs-on: ubuntu-latest

    # üêò –ë–ª–æ–∫ services ‚Äî –∞–Ω–∞–ª–æ–≥ docker-compose:
    # –æ–ø–∏—Å—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã
    # –≤–º–µ—Å—Ç–µ —Å —Ä–∞–Ω–Ω–µ—Ä–æ–º. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ ‚Äî PostgreSQL.
    services:
      postgres:
        # üê≥ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ PostgreSQL, –≤–µ—Ä—Å–∏—è 13.10
        image: postgres:13.10
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ë–î
        # –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤
        env:
          POSTGRES_USER: django_user           # –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
          POSTGRES_PASSWORD: django_password   # –ø–∞—Ä–æ–ª—å
          POSTGRES_DB: django_db               # –∏–º—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
        # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ —Ö–æ—Å—Ç:
        # 5432 —Ö–æ—Å—Ç–∞ ‚Üí 5432 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç PostgreSQL)
        ports:
          - 5432:5432
        # ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
        # –ë–µ–∑ —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ,
        # —á–µ–º —Å–µ—Ä–≤–µ—Ä –ë–î –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      # 1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–∞–Ω–Ω–µ—Ä–∞
      - name: Check out code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12    # –≤–µ—Ä—Å–∏—è Python –¥–ª—è –ø—Ä–æ–≥–æ–Ω–∞ –ª–∏–Ω—Ç–µ—Ä–∞ –∏ —Ç–µ—Å—Ç–æ–≤

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ª–∏–Ω—Ç–µ—Ä–æ–≤
      - name: Install dependencies
        run: |
          # –û–±–Ω–æ–≤–ª—è–µ–º pip –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
          python -m pip install --upgrade pip setuptools
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º flake8 –∏ flake8-isort –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª—è –∫–æ–¥–∞
          pip install flake8==6.0.0 flake8-isort==6.0.0
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt –¥–ª—è Django –ø—Ä–æ–µ–∫—Ç–∞
          pip install -r ./backend/requirements.txt 

      # 4Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä flake8 –∏ —Ç–µ—Å—Ç—ã
      - name: Test with flake8 and django tests
        # –ü–µ—Ä–µ–¥–∞—ë–º Django –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        # (–æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ settings.py)
        env:
          POSTGRES_USER: django_user           # –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
          POSTGRES_PASSWORD: django_password   # –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
          POSTGRES_DB: django_db               # –∏–º—è –ë–î
          DB_HOST: 127.0.0.1                   # —Ö–æ—Å—Ç ‚Äî —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —Ä–∞–Ω–Ω–µ—Ä–∞
          DB_PORT: 5432                        # –ø–æ—Ä—Ç, –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω—ã–π –≤ services
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä flake8 –¥–ª—è –ø–∞–ø–∫–∏ backend
          python -m flake8 backend/
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ Django
          cd backend/
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ Django —Ç–µ—Å—Ç—ã
          python manage.py test
