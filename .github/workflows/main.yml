# –ù–∞–∑–≤–∞–Ω–∏–µ workflow ‚Äî —Ç–∞–∫ –æ–Ω –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ Actions
name: Main Taski workflow

# –£–∫–∞–∑—ã–≤–∞–µ–º, –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–æ—Ç workflow:
# ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches: [ main ]

jobs:
  # –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∂–æ–±–∞ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º, —Ç—É—Ç 'tests'
  tests:
    # GitHub –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å—ë –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å Ubuntu
    runs-on: ubuntu-latest

    # üì¶ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã ‚Äî –∑–¥–µ—Å—å –ø–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å PostgreSQL
    services:
      postgres:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Postgres –≤–µ—Ä—Å–∏–∏ 13.10
        image: postgres:13.10
        # –ó–∞–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î
        env:
          POSTGRES_USER: django_user        # –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
          POSTGRES_PASSWORD: django_password # –ø–∞—Ä–æ–ª—å
          POSTGRES_DB: django_db            # –∏–º—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
        # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ —Ö–æ—Å—Ç
        ports:
          - 5432:5432
        # ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤
        options: >-
          --health-cmd "pg_isready -U django_user -d django_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1Ô∏è‚É£ –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–∞–Ω–Ω–µ—Ä–∞
      - name: Check out code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.12 –≤ —Ä–∞–Ω–Ω–µ—Ä
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ª–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Install dependencies
        run: |
          # –û–±–Ω–æ–≤–ª—è–µ–º pip –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
          python -m pip install --upgrade pip setuptools wheel
          # –°—Ç–∞–≤–∏–º –ª–∏–Ω—Ç–µ—Ä—ã
          pip install flake8==6.0.0 flake8-isort==6.0.0
          # –°—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ requirements.txt
          pip install -r ./backend/requirements.txt

      # 4Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä flake8, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∏–ª—å –∫–æ–¥–∞
      - name: Lint with flake8
        run: python -m flake8 backend/

      # 5Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º Django-—Ç–µ—Å—Ç—ã, —É–∫–∞–∑–∞–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Postgres
      - name: Run Django tests
        working-directory: backend    # –∑–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –ø–∞–ø–∫–∏ backend
        env:
          POSTGRES_USER: django_user        # —Ç–µ –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ –∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          POSTGRES_PASSWORD: django_password
          POSTGRES_DB: django_db
          DB_HOST: 127.0.0.1                # —Ö–æ—Å—Ç ‚Äî —ç—Ç–æ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç (–ø–æ—Ä—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω)
          DB_PORT: 5432                     # –ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: python manage.py test          # –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ Django
